#!/usr/bin/env bash

set -Ee          # exit immediately on command failure
set -o pipefail  # treat failure within a pipe as failure
set -u           # disallow unset variables

# checks if RDP port is open since ping is ignored
HOST_UP_COMMAND="nc -w2 -z 10.0.0.232 3389"
WAKE_COMMAND="wake_bpc"
PARSEC_COMMAND="parsec"
# give the host this many seconds to be 'up' after sending a wake command
# NOTES: 8 seconds too short
DELAY_AFTER_WAKE_SECS="10"

until $HOST_UP_COMMAND &> /dev/null
do
  echo "Host down, sending wake command..."
  $WAKE_COMMAND
  sleep "$DELAY_AFTER_WAKE_SECS"
done

# run parsec
echo "Host up!"
$PARSEC_COMMAND

